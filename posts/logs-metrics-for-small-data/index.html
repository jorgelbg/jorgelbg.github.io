<!DOCTYPE html>
<html lang="en-us">
	<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Jorge Luis Betancourt">
<meta name="description" content="Computo Ergo Sum">
<meta name="generator" content="Hugo 0.42.1" />
<title>Logs and metrics for Small Data</title>
<link rel="shortcut icon" href="http://jorgelbg.github.io/images/favicon.ico">
<link rel="stylesheet" href="http://jorgelbg.github.io/css/style.css">
<link rel="stylesheet" href="http://jorgelbg.github.io/css/highlight.css">

<link rel="stylesheet" href="http://jorgelbg.github.io/css/custom.css">



<link rel="stylesheet" href="http://jorgelbg.github.io/css/monosocialiconsfont.css">



<link href="http://jorgelbg.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Jorge Luis Betancourt" />


<meta property="og:title" content="Logs and metrics for Small Data" />
<meta property="og:description" content="Use Docker, ELK stack, Prometheus and Grafana to solve common problems in your local environment." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://jorgelbg.github.io/posts/logs-metrics-for-small-data/" />



<meta property="article:published_time" content="2018-08-23T05:42:44&#43;02:00"/>

<meta property="article:modified_time" content="2018-08-23T05:42:44&#43;02:00"/>













<meta itemprop="name" content="Logs and metrics for Small Data">
<meta itemprop="description" content="Use Docker, ELK stack, Prometheus and Grafana to solve common problems in your local environment.">


<meta itemprop="datePublished" content="2018-08-23T05:42:44&#43;02:00" />
<meta itemprop="dateModified" content="2018-08-23T05:42:44&#43;02:00" />
<meta itemprop="wordCount" content="1099">



<meta itemprop="keywords" content="" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Logs and metrics for Small Data"/>
<meta name="twitter:description" content="Use Docker, ELK stack, Prometheus and Grafana to solve common problems in your local environment."/>
<meta name="twitter:site" content="@https://www.twitter.com/jorgelbgm"/>


    </head>
<body>
    <nav class="main-nav">
	
		<a href='http://jorgelbg.github.io/'> <span class="arrow">‚Üê</span>Home</a>
	

	

	
		<a class="cta" href="http://jorgelbg.github.io/index.xml">Subscribe</a>
	
</nav>

    <section id="wrapper">
        
        
<article class="post">
    <header>
        <h1>Logs and metrics for Small Data</h1>
        <h2 class="subtitle">Use Docker, ELK stack, Prometheus and Grafana to solve common problems in your local environment.</h2>
        <h2 class="headline">
        August 23, 2018
        <br>
        
        </h2>
    </header>
    <section id="post-body">
        

<p>This post is a personal comment. I&rsquo;m going to talk about how using some tools
thought for &ldquo;Big Data&rdquo;‚Ñ¢ makes sense for common development tasks. If you hear
someone talking about ELK, Grafana or Prometheus, you wouldn&rsquo;t think about a
system to run your laptop during development, right?</p>

<h2 id="logs">Logs</h2>

<p>Concatenating files, parsing logs, are some of those tasks that are part of our
daily routine as developers. We type lots of commands (usually connected via
pipes <code>|</code>) to accomplish a given goal.</p>

<p>Of course, I love my terminal. I spend a great amount of time in the console:
committing code,  running tests, etc. I guess that typing something like:</p>

<pre><code>$ cat ../../fixtures/json/payload1.json | tr -d '\n' | gsed 's/]}/]}\n/g' | phony --tick 100ms | ./main
</code></pre>

<p>comes natural to a lot of developers out there.</p>

<p>A few days ago, in my spare time, I was troubleshooting a bug with a Java
application. I was debugging a local run of a crawl cycle using <a href="http://nutch.apache.org/">Apache
Nutch</a>. My normal workflow involves several panels in
my terminal (iTerm) and a lot of <code>cat</code>, <code>grep</code>, <code>sed</code>, etc.</p>

<p>At some point, I realized that the events I was looking for in the logs were
spread in several log files and in different positions. Finding those events was
not going to be easy. I needed to not only find one specific line, but the cases
happening around that specific line.</p>

<p>And, it hit me. I have to do this several times a day at my normal job. As part
of the Web performance team, we need to watch graphs and find specific events in
the logs of hundreds of servers. Of course, dealing with that amount of data
requires some infrastructure. We have an <a href="https://www.elastic.co/elk-stack">ELK</a>
cluster that holds several TBs of logs, and we use
<a href="https://www.elastic.co/products/kibana">Kibana</a> on a daily basis for this very
purpose. It has to be like this, no one would think of maintaining an
application at this scale without a centralized logging system.</p>

<p>Well, why couldn‚Äôt I use the same setup in my project? Right? Turns out that
replicating a similar setup on my laptop wasn‚Äôt that difficult. Docker and the
fact that Elastic provides all its products as Docker images was a blessing.</p>

<p>I only needed to send the logs to Elasticsearch, then search the desired
information using Kibana.</p>

<p>I used Logstash to ingest the logs, you need to figure out how you want your
logs stored in Elasticsearch. It&rsquo;s possible that you&rsquo;ll (<a href="https://sematext.com/blog/handling-stack-traces-with-logstash/">need to deal with
Java Stack traces</a>.
There are plenty of resources on how to do this (and more) online.</p>

<p>Now it was only a matter of running one more container: Kibana. Which allowed
using the full-text search capabilities of Elasticsearch.</p>

<p>The best of all: Although I spent some more minutes settings things up, no more
than 30 minutes, for sure. The setup is already there for the next time that I
need to use it.</p>

<p>It‚Äôs amazing how Docker have allowed us to run these tools without any complex
installation. Could I‚Äôve done the same using the good old terminal commands?
Definitively! But sometimes is easier to use the same setup that you have for
dealing with hundreds of servers.</p>

<h2 id="metrics">Metrics</h2>

<p>The second part of this post is about metrics. Recently I‚Äôve been working on a
very interesting project at work. Enough to say that involves HTTP connections
and payloads.</p>

<p>In the beginning, we focus on building the prototype and validating the initial
idea. Then, we structured the code as a reusable library. But, at some point
in-between we were curious to see how our little experiment was behaving.</p>

<p>Since this was only to please our curiosity we didn‚Äôt want to spend a lot of
time on it.  What we needed was at the core a histogram, so we wrote a little
piece of code. Calculate the length of the payload and store that as a key of
the map and a counter as the value. At the end of our test, we printed the map
to the terminal.</p>

<p>It‚Äôs no coincidence that I‚Äôm in the Web Performance Team ü§î we are responsible
for looking at graphs the entire day. I like graphs! I wanted to see some
graphs!</p>

<p>On a more serious note, although the map allowed us to see the distribution of
the payload size, we still lacked one thing. How was our code behaving <em>over time</em>?
For this, we changed our implementation and printed the first <code>N</code> samples to the
terminal. Of course, at some point, I just copied the numbers into Excel and
created a couple of graphs (I mentioned that I like graphs right?).</p>

<p>After we implemented the core feature of the application, I still wanted to see
some &ldquo;real time&rdquo; graphs. I mean, the Excel visualization was great, but it was
not very interactive.</p>

<p>At this point again, I realized that we‚Äôve already solved this problem on a
larger scale. We use InfluxDB &amp; Grafana for creating dashboards and monitoring
our entire infrastructure &amp; application. More recently we‚Äôve been using
Prometheus and the new pull approach as well.</p>

<p>I didn‚Äôt want to send the metrics of my local application into our production
InfluxDB server. There was no good reason to do so. I ended up replicating our
‚Äúproduction‚Äù environment on my laptop for my personal use.</p>

<p>A simple <code>docker-compose.yml</code> file with only 57 lines and a few default config
files in my local repo were enough. Ok, I ended up wanting to try the new
<a href="https://promcon.io/2018-munich/talks/explore-your-prometheus-data-in-grafana/">Grafana Explore UI for
Prometheus</a>
so I added one more config file for Grafana.</p>

<p>A few more lines to instrument my code with
<a href="https://github.com/prometheus/client_golang">client_golang</a> and that was it.</p>

<p>The best part, beautiful interactive graphs, that are a pleasure to use. And
they&rsquo;re very useful for spotting problems.</p>

<p><img src="/images/logs-and-metrics/grafana-prometheus.png" alt="Grafana dashboard with Prometheus
datasource" title="Grafana dashboard" /></p>

<h2 id="tl-dr">TL;DR</h2>

<p>We often hear how good Docker is for replicating your local environment in
production. Or how it can revolutionize your CI/CD pipeline. We also heard about
the new version of &ldquo;it works on my machine&rdquo; üòÇ</p>

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Before DevOps / After DevOps<a href="https://twitter.com/hashtag/comic?src=hash&amp;ref_src=twsrc%5Etfw">#comic</a> <a href="https://twitter.com/hashtag/devops?src=hash&amp;ref_src=twsrc%5Etfw">#devops</a> <a href="https://twitter.com/hashtag/sysadmin?src=hash&amp;ref_src=twsrc%5Etfw">#sysadmin</a><a href="https://t.co/SQjVLTcV6Z">https://t.co/SQjVLTcV6Z</a> <a href="https://t.co/gVwcvcv2h1">pic.twitter.com/gVwcvcv2h1</a></p>&mdash; turnoff.us (@turnoff_us) <a href="https://twitter.com/turnoff_us/status/917564505416073216?ref_src=twsrc%5Etfw">October 10, 2017</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>And of course, it&rsquo;s true, but sometimes we forget that it also works the other
way around. Docker allows developers to apply already proven solutions to
problems in a local environment.</p>

<p>Tools like Elasticsearch, Logstash, and Kibana can deal with huge amounts of
data. But, can also work for &ldquo;small data&rdquo; problems, like debugging some issues
in your local environment.</p>

<p>At the same time, Prometheus, InfluxDB, and Grafana have made storing and
visualizing metrics a very easy task. Even for that small application that
you&rsquo;re developing on your laptop.</p>

    </section>
</article>

<footer id="post-meta" class="clearfix">
    <a href="https://twitter.com/jorgelbg">
    <img class="avatar" src="http://jorgelbg.github.io/images/avatar.png">
    <div>
        <span class="dark">Jorge Luis Betancourt</span>
        <span>Software engineer with a passion for data, search and performance</span>
    </div>
    </a>
    <section id="sharing">
        <a class="twitter" href="https://twitter.com/intent/tweet?text=http%3a%2f%2fjorgelbg.github.io%2fposts%2flogs-metrics-for-small-data%2f - Logs%20and%20metrics%20for%20Small%20Data by @jorgelbg"><span class="icon-twitter"> tweet</span></a>

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>

    </section>
</footer>

<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "jorgelbg" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<ul id="post-list" class="archive readmore">
    <h3>Read more</h3>

    
    
    
        <li>
            <a href="/posts/solr-contextual-synonyms/">Solr Contextual Synonyms with Payloads<aside class="dates">Mar 6 2018</aside></a>
        </li>
    
</ul>



        <footer id="footer">
    
        <div id="social">

	
	
    
    <a class="symbol" href="https://www.github.com/jorgelbg">
        circlegithub
    </a>
    
    <a class="symbol" href="https://www.twitter.com/jorgelbgm">
        circletwitterbird
    </a>
    


</div>

    
    <p class="small">
    
        ¬© Copyright 2018 Jorge Luis Betancourt
    
    </p>
</footer>

    </section>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="http://jorgelbg.github.io/js/main.js"></script>
<script src="http://jorgelbg.github.io/js/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




<script>
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-115201846-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


</body>
</html>
