<!DOCTYPE html>
<html lang="en-us">
	<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="author" content="Jorge Luis Betancourt">
<meta name="description" content="Computo Ergo Sum">
<meta name="generator" content="Hugo 0.54.0" />
<title>Logs and metrics for Small Data</title>
<link rel="shortcut icon" href="http://jorgelbg.github.io/images/favicon.ico">
<link rel="stylesheet" href="http://jorgelbg.github.io/css/style.css">
<link rel="stylesheet" href="http://jorgelbg.github.io/css/highlight.css">

<link rel="stylesheet" href="http://jorgelbg.github.io/css/custom.css">



<link href="http://jorgelbg.github.io/index.xml" rel="alternate" type="application/rss+xml" title="Jorge Luis Betancourt" />


<meta property="og:title" content="Logs and metrics for Small Data" />
<meta property="og:description" content="Use Docker, ELK stack, Prometheus and Grafana to solve common problems in your local environment." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://jorgelbg.github.io/2018/08/logs-and-metrics-for-small-data/" />
<meta property="article:published_time" content="2018-08-23T05:42:44&#43;02:00"/>
<meta property="article:modified_time" content="2018-08-23T05:42:44&#43;02:00"/>



<meta itemprop="name" content="Logs and metrics for Small Data">
<meta itemprop="description" content="Use Docker, ELK stack, Prometheus and Grafana to solve common problems in your local environment.">


<meta itemprop="datePublished" content="2018-08-23T05:42:44&#43;02:00" />
<meta itemprop="dateModified" content="2018-08-23T05:42:44&#43;02:00" />
<meta itemprop="wordCount" content="1099">



<meta itemprop="keywords" content="" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Logs and metrics for Small Data"/>
<meta name="twitter:description" content="Use Docker, ELK stack, Prometheus and Grafana to solve common problems in your local environment."/>
<meta name="twitter:site" content="@https://www.twitter.com/jorgelbgm"/>


    </head>
<body>
    <nav class="main-nav">
	
		<a href='http://jorgelbg.github.io/'>
			<svg height="30" fill="#5661B3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 492 492"><path d="M464.344 207.418l.768.168H135.888l103.496-103.724c5.068-5.064 7.848-11.924 7.848-19.124 0-7.2-2.78-14.012-7.848-19.088L223.28 49.538c-5.064-5.064-11.812-7.864-19.008-7.864-7.2 0-13.952 2.78-19.016 7.844L7.844 226.914C2.76 231.998-.02 238.77 0 245.974c-.02 7.244 2.76 14.02 7.844 19.096l177.412 177.412c5.064 5.06 11.812 7.844 19.016 7.844 7.196 0 13.944-2.788 19.008-7.844l16.104-16.112c5.068-5.056 7.848-11.808 7.848-19.008 0-7.196-2.78-13.592-7.848-18.652L134.72 284.406h329.992c14.828 0 27.288-12.78 27.288-27.6v-22.788c0-14.82-12.828-26.6-27.656-26.6z"/></svg>
			
		</a>
	

	

	
</nav>

    <section id="wrapper">
        
        
<article class="post">
    <header>
        <h1>Logs and metrics for Small Data</h1>
        <h2 class="subtitle">Use Docker, ELK stack, Prometheus and Grafana to solve common problems in your local environment.</h2>
        <h2 class="headline">
        August 23, 2018
        <br>
        
        </h2>
    </header>
    <section id="post-body">
        

<p>This post is a personal comment. I&rsquo;m going to talk about how using some tools
thought for &ldquo;Big Data&rdquo;‚Ñ¢ makes sense for common development tasks. If you hear
someone talking about ELK, Grafana or Prometheus, you wouldn&rsquo;t think about a
system to run your laptop during development, right?</p>

<h2 id="logs">Logs</h2>

<p>Concatenating files, parsing logs, are some of those tasks that are part of our
daily routine as developers. We type lots of commands (usually connected via
pipes <code>|</code>) to accomplish a given goal.</p>

<p>Of course, I love my terminal. I spend a great amount of time in the console:
committing code,  running tests, etc. I guess that typing something like:</p>

<pre><code>$ cat ../../fixtures/json/payload1.json | tr -d '\n' | gsed 's/]}/]}\n/g' | phony --tick 100ms | ./main
</code></pre>

<p>comes natural to a lot of developers out there.</p>

<p>A few days ago, in my spare time, I was troubleshooting a bug with a Java
application. I was debugging a local run of a crawl cycle using <a href="http://nutch.apache.org/">Apache
Nutch</a>. My normal workflow involves several panels in
my terminal (iTerm) and a lot of <code>cat</code>, <code>grep</code>, <code>sed</code>, etc.</p>

<p>At some point, I realized that the events I was looking for in the logs were
spread in several log files and in different positions. Finding those events was
not going to be easy. I needed to not only find one specific line, but the cases
happening around that specific line.</p>

<p>And, it hit me. I have to do this several times a day at my normal job. As part
of the Web performance team, we need to watch graphs and find specific events in
the logs of hundreds of servers. Of course, dealing with that amount of data
requires some infrastructure. We have an <a href="https://www.elastic.co/elk-stack">ELK</a>
cluster that holds several TBs of logs, and we use
<a href="https://www.elastic.co/products/kibana">Kibana</a> on a daily basis for this very
purpose. It has to be like this, no one would think of maintaining an
application at this scale without a centralized logging system.</p>

<p>Well, why couldn‚Äôt I use the same setup in my project? Right? Turns out that
replicating a similar setup on my laptop wasn‚Äôt that difficult. Docker and the
fact that Elastic provides all its products as Docker images was a blessing.</p>

<p>I only needed to send the logs to Elasticsearch, then search the desired
information using Kibana.</p>

<p>I used Logstash to ingest the logs, you need to figure out how you want your
logs stored in Elasticsearch. It&rsquo;s possible that you&rsquo;ll (<a href="https://sematext.com/blog/handling-stack-traces-with-logstash/">need to deal with
Java Stack traces</a>.
There are plenty of resources on how to do this (and more) online.</p>

<p>Now it was only a matter of running one more container: Kibana. Which allowed
using the full-text search capabilities of Elasticsearch.</p>

<p>The best of all: Although I spent some more minutes settings things up, no more
than 30 minutes, for sure. The setup is already there for the next time that I
need to use it.</p>

<p>It‚Äôs amazing how Docker have allowed us to run these tools without any complex
installation. Could I‚Äôve done the same using the good old terminal commands?
Definitively! But sometimes is easier to use the same setup that you have for
dealing with hundreds of servers.</p>

<h2 id="metrics">Metrics</h2>

<p>The second part of this post is about metrics. Recently I‚Äôve been working on a
very interesting project at work. Enough to say that involves HTTP connections
and payloads.</p>

<p>In the beginning, we focus on building the prototype and validating the initial
idea. Then, we structured the code as a reusable library. But, at some point
in-between we were curious to see how our little experiment was behaving.</p>

<p>Since this was only to please our curiosity we didn‚Äôt want to spend a lot of
time on it.  What we needed was at the core a histogram, so we wrote a little
piece of code. Calculate the length of the payload and store that as a key of
the map and a counter as the value. At the end of our test, we printed the map
to the terminal.</p>

<p>It‚Äôs no coincidence that I‚Äôm in the Web Performance Team ü§î we are responsible
for looking at graphs the entire day. I like graphs! I wanted to see some
graphs!</p>

<p>On a more serious note, although the map allowed us to see the distribution of
the payload size, we still lacked one thing. How was our code behaving <em>over time</em>?
For this, we changed our implementation and printed the first <code>N</code> samples to the
terminal. Of course, at some point, I just copied the numbers into Excel and
created a couple of graphs (I mentioned that I like graphs right?).</p>

<p>After we implemented the core feature of the application, I still wanted to see
some &ldquo;real time&rdquo; graphs. I mean, the Excel visualization was great, but it was
not very interactive.</p>

<p>At this point again, I realized that we‚Äôve already solved this problem on a
larger scale. We use InfluxDB &amp; Grafana for creating dashboards and monitoring
our entire infrastructure &amp; application. More recently we‚Äôve been using
Prometheus and the new pull approach as well.</p>

<p>I didn‚Äôt want to send the metrics of my local application into our production
InfluxDB server. There was no good reason to do so. I ended up replicating our
‚Äúproduction‚Äù environment on my laptop for my personal use.</p>

<p>A simple <code>docker-compose.yml</code> file with only 57 lines and a few default config
files in my local repo were enough. Ok, I ended up wanting to try the new
<a href="https://promcon.io/2018-munich/talks/explore-your-prometheus-data-in-grafana/">Grafana Explore UI for
Prometheus</a>
so I added one more config file for Grafana.</p>

<p>A few more lines to instrument my code with
<a href="https://github.com/prometheus/client_golang">client_golang</a> and that was it.</p>

<p>The best part, beautiful interactive graphs, that are a pleasure to use. And
they&rsquo;re very useful for spotting problems.</p>

<p><img src="/images/logs-and-metrics/grafana-prometheus.png" alt="Grafana dashboard with Prometheus
datasource" title="Grafana dashboard" /></p>

<h2 id="tl-dr">TL;DR</h2>

<p>We often hear how good Docker is for replicating your local environment in
production. Or how it can revolutionize your CI/CD pipeline. We also heard about
the new version of &ldquo;it works on my machine&rdquo; üòÇ</p>

<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Before DevOps / After DevOps<a href="https://twitter.com/hashtag/comic?src=hash&amp;ref_src=twsrc%5Etfw">#comic</a> <a href="https://twitter.com/hashtag/devops?src=hash&amp;ref_src=twsrc%5Etfw">#devops</a> <a href="https://twitter.com/hashtag/sysadmin?src=hash&amp;ref_src=twsrc%5Etfw">#sysadmin</a><a href="https://t.co/SQjVLTcV6Z">https://t.co/SQjVLTcV6Z</a> <a href="https://t.co/gVwcvcv2h1">pic.twitter.com/gVwcvcv2h1</a></p>&mdash; turnoff.us (@turnoff_us) <a href="https://twitter.com/turnoff_us/status/917564505416073216?ref_src=twsrc%5Etfw">October 10, 2017</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>And of course, it&rsquo;s true, but sometimes we forget that it also works the other
way around. Docker allows developers to apply already proven solutions to
problems in a local environment.</p>

<p>Tools like Elasticsearch, Logstash, and Kibana can deal with huge amounts of
data. But, can also work for &ldquo;small data&rdquo; problems, like debugging some issues
in your local environment.</p>

<p>At the same time, Prometheus, InfluxDB, and Grafana have made storing and
visualizing metrics a very easy task. Even for that small application that
you&rsquo;re developing on your laptop.</p>

    </section>
</article>

<footer id="post-meta" class="clearfix">
    <a href="https://twitter.com/jorgelbg">
    <img class="avatar" src="http://jorgelbg.github.io/images/avatar.png">
    <div>
        <span class="dark">Jorge Luis Betancourt</span>
        <span>Software engineer with a passion for data, search and performance</span>
    </div>
    </a>
    <section id="sharing">
        <a class="twitter" href="https://twitter.com/intent/tweet?text=http%3a%2f%2fjorgelbg.github.io%2f2018%2f08%2flogs-and-metrics-for-small-data%2f - Logs%20and%20metrics%20for%20Small%20Data by @jorgelbg"><span class="icon-twitter"> tweet</span></a>

<a class="facebook" href="#" onclick="
    window.open(
      'https://www.facebook.com/sharer/sharer.php?u='+encodeURIComponent(location.href),
      'facebook-share-dialog',
      'width=626,height=436');
    return false;"><span class="icon-facebook-rect"> Share</span>
</a>

    </section>
</footer>



<ul id="post-list" class="archive readmore">
    <h3>Read more</h3>

    
    
    
        <li>
            <a href="/2019/03/useful-alerts-with-elastic-watcher-machine-learning/">Useful alerts with Elastic Watcher &amp; Machine Learning<aside class="dates">Mar 15 2019</aside></a>
        </li>
    
        <li>
            <a href="/2019/02/display-the-applications-version-in-your-grafana-dashboards/">Display the application&#39;s version in your Grafana dashboards<aside class="dates">Feb 17 2019</aside></a>
        </li>
    
        <li>
            <a href="/2018/12/optimize-grafana-dashboards-with-elasticsearch-index-aliases/">Optimize Grafana dashboards with Elasticsearch index aliases<aside class="dates">Dec 20 2018</aside></a>
        </li>
    
        <li>
            <a href="/2018/03/solr-contextual-synonyms-with-payloads/">Solr Contextual Synonyms with Payloads<aside class="dates">Mar 6 2018</aside></a>
        </li>
    
</ul>



        <footer id="footer">
    
        <div id="social">
    
    <a class="symbol github" href="https://github.com/jorgelbg">
    
        <svg height="30" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M255.968 5.329C114.624 5.329 0 120.401 0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384 0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008 0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992 0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584 0 34.368-.32 62.08-.32 70.496 0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"/></svg>
    
    </a>
    
    <a class="symbol twitter" href="https://www.twitter.com/jorgelbgm">
    
        <svg height="30" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612"><path d="M612 116.258a250.714 250.714 0 0 1-72.088 19.772c25.929-15.527 45.777-40.155 55.184-69.411-24.322 14.379-51.169 24.82-79.775 30.48-22.907-24.437-55.49-39.658-91.63-39.658-69.334 0-125.551 56.217-125.551 125.513 0 9.828 1.109 19.427 3.251 28.606-104.326-5.24-196.835-55.223-258.75-131.174-10.823 18.51-16.98 40.078-16.98 63.101 0 43.559 22.181 81.993 55.835 104.479a125.556 125.556 0 0 1-56.867-15.756v1.568c0 60.806 43.291 111.554 100.693 123.104-10.517 2.83-21.607 4.398-33.08 4.398-8.107 0-15.947-.803-23.634-2.333 15.985 49.907 62.336 86.199 117.253 87.194-42.947 33.654-97.099 53.655-155.916 53.655-10.134 0-20.116-.612-29.944-1.721 55.567 35.681 121.536 56.485 192.438 56.485 230.948 0 357.188-191.291 357.188-357.188l-.421-16.253c24.666-17.593 46.005-39.697 62.794-64.861z" fill="#010002"/></svg>
    
    </a>
    
    
    <a href="http://jorgelbg.github.io/index.xml" class="symbol rss">
        <svg height="28" version="1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 559 559"><path d="M53 0a497 497 0 0 1 358 148 508 508 0 0 1 148 358c0 15-5 27-15 38a51 51 0 0 1-38 15c-15 0-27-5-38-15a51 51 0 0 1-15-38 390 390 0 0 0-117-282A400 400 0 0 0 53 106 52 52 0 0 1 0 53c0-14 5-27 16-37C26 5 39 0 53 0zm0 201c42 0 82 8 119 25s69 37 96 65a312 312 0 0 1 90 215c0 15-5 27-16 38a51 51 0 0 1-37 15c-15 0-27-5-38-15a51 51 0 0 1-15-38 192 192 0 0 0-59-140 201 201 0 0 0-140-58c-14 0-27-5-37-16-11-10-16-23-16-37s5-28 16-38c10-10 23-16 37-16zm98 280a73 73 0 0 1-45 69c-10 4-19 6-30 6a73 73 0 0 1-68-46 74 74 0 0 1 39-98 74 74 0 0 1 104 69z" fill="#010002"/></svg>
    </a>
    
</div>

    
    <p class="small">
    
        ¬© Copyright 2019 Jorge Luis Betancourt
    
    </p>
</footer>

    </section>
    

<script src="http://jorgelbg.github.io/js/highlight.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-115201846-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


</body>
</html>
