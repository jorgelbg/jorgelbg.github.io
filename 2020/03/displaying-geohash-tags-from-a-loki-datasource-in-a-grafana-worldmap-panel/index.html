<!doctype html><html lang=en-us><head><link rel=preload href=//jorgelbg.me/css/style.css as=style><link rel=stylesheet href=//jorgelbg.me/css/style.css media=print onload="this.media='all'"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Jorge Luis Betancourt"><meta name=description content="Computo Ergo Sum"><meta name=generator content="Hugo 0.60.1"><title>Displaying geohash tags from a Loki datasource in a Grafana Worldmap Panel</title><link rel="shortcut icon" href=//jorgelbg.me/images/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><link rel=dns-prefetch href=//www.google-analytics.com/><link href=//jorgelbg.me/index.xml rel=alternate type=application/rss+xml title="Jorge Luis Betancourt"><meta property="og:title" content="Displaying geohash tags from a Loki datasource in a Grafana Worldmap Panel"><meta property="og:description" content="How to use Loki and the Worldmap panel plugin to show geohashes or latitude/longitude pairs in a map."><meta property="og:type" content="article"><meta property="og:url" content="//jorgelbg.me/2020/03/displaying-geohash-tags-from-a-loki-datasource-in-a-grafana-worldmap-panel/"><meta property="article:published_time" content="2020-03-18T00:00:00+01:00"><meta property="article:modified_time" content="2020-03-18T02:00:44+01:00"><meta itemprop=name content="Displaying geohash tags from a Loki datasource in a Grafana Worldmap Panel"><meta itemprop=description content="How to use Loki and the Worldmap panel plugin to show geohashes or latitude/longitude pairs in a map."><meta itemprop=datePublished content="2020-03-18T00:00:00+01:00"><meta itemprop=dateModified content="2020-03-18T02:00:44+01:00"><meta itemprop=wordCount content="746"><meta itemprop=keywords content="grafana,loki,worldmap,geohash,"><meta name=twitter:card content="summary"><meta name=twitter:title content="Displaying geohash tags from a Loki datasource in a Grafana Worldmap Panel"><meta name=twitter:description content="How to use Loki and the Worldmap panel plugin to show geohashes or latitude/longitude pairs in a map."><meta name=twitter:site content="@https://twitter.com/jorgelbg"></head><body><section id=wrapper><nav class=main-nav><a href=//jorgelbg.me></a></nav><article class=post><header><h1><a href=//jorgelbg.me/2020/03/displaying-geohash-tags-from-a-loki-datasource-in-a-grafana-worldmap-panel/><svg width="24" viewBox="0 0 512.1 512.1"><path d="M312 2e2c-6-7-12-12-20-17a119 119 0 00-149 17L35 308a119 119 0 00169 169l89-89a9 9 0 00-6-15h-3c-19 0-37-3-55-10-3-2-7-1-9 1l-64 65a51 51 0 11-73-73l109-108c20-20 53-20 72 0 14 12 35 12 48 0 6-6 10-14 10-22 1-10-3-19-10-26z"/><path d="M477 35c-47-47-122-47-169 0l-89 89a9 9 0 006 15h3c19 0 37 4 55 11 3 1 6 0 9-2l64-64a51 51 0 1173 72l-81 80v1l-28 28a51 51 0 01-73 0 35 35 0 00-48 0 34 34 0 000 48c10 10 22 18 35 24l5 2 5 2 6 2 5 1a138 138 0 0023 3h12l6-1h8l3-1 5-1h1c21-5 40-16 55-31l109-109c47-47 47-122 0-169z"/></svg>Displaying geohash tags from a Loki datasource in a Grafana Worldmap Panel</a></h1><h2 class=headline><span>March 18, 2020</span>
<span class=tag><svg fill="#718096" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"><path class="heroicon-ui" d="M2.59 13.41A1.98 1.98.0 012 12V7a5 5 0 015-5h4.99c.53.0 1.04.2 1.42.59l8 8a2 2 0 010 2.82l-8 8a2 2 0 01-2.82.0l-8-8zM20 12l-8-8H7A3 3 0 004 7v5l8 8 8-8zM7 8a1 1 0 110-2 1 1 0 010 2z"/></svg><a style=margin-left:10px href=//jorgelbg.me/tags/grafana>grafana</a></span>
<span class=tag><svg fill="#718096" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"><path class="heroicon-ui" d="M2.59 13.41A1.98 1.98.0 012 12V7a5 5 0 015-5h4.99c.53.0 1.04.2 1.42.59l8 8a2 2 0 010 2.82l-8 8a2 2 0 01-2.82.0l-8-8zM20 12l-8-8H7A3 3 0 004 7v5l8 8 8-8zM7 8a1 1 0 110-2 1 1 0 010 2z"/></svg><a style=margin-left:10px href=//jorgelbg.me/tags/loki>loki</a></span>
<span class=tag><svg fill="#718096" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"><path class="heroicon-ui" d="M2.59 13.41A1.98 1.98.0 012 12V7a5 5 0 015-5h4.99c.53.0 1.04.2 1.42.59l8 8a2 2 0 010 2.82l-8 8a2 2 0 01-2.82.0l-8-8zM20 12l-8-8H7A3 3 0 004 7v5l8 8 8-8zM7 8a1 1 0 110-2 1 1 0 010 2z"/></svg><a style=margin-left:10px href=//jorgelbg.me/tags/worldmap>worldmap</a></span>
<span class=tag><svg fill="#718096" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"><path class="heroicon-ui" d="M2.59 13.41A1.98 1.98.0 012 12V7a5 5 0 015-5h4.99c.53.0 1.04.2 1.42.59l8 8a2 2 0 010 2.82l-8 8a2 2 0 01-2.82.0l-8-8zM20 12l-8-8H7A3 3 0 004 7v5l8 8 8-8zM7 8a1 1 0 110-2 1 1 0 010 2z"/></svg><a style=margin-left:10px href=//jorgelbg.me/tags/geohash>geohash</a></span></h2><p class=last-edited><a href=https://github.com/jorgelbg/jorgelbg.github.io/commit/e4c0f2de8e2f113231f36c8dd82e9d64df9b36df title="Remove the draft status for the Loki & Grafana article">Last edited on 18 March 2020</a></p></header><section id=post-body><p><a href=https://grafana.com/oss/loki/>Loki</a> is a new~ish project from <a href=https://grafana.com>Grafana</a>, yes
the same company behind the popular open-source observability platform. Loki itself is a
horizontally-scalable, highly-available, multi-tenant log aggregation system inspired by Prometheus.</p><p>On fewer words, Loki is like Prometheus but for your logs. This means that although it doesn't
provide all the full-text search capabilities of Elasticsearch, it allows filtering by a set of
labels for each log stream. This translates into a more cost-effective solution.</p><p>Even though Loki was announced on <a href=https://kccna18.sched.com/event/GrXC/on-the-oss-path-to-full-observability-with-grafana-david-kaltschmidt-grafana-labs>KubeCon
18&rsquo;</a>.
It is still under active development. As expected the team is building in parallel the internal Loki
components: ingestion, storage, and query layer and the visualization UI (Grafana). It was not until recently that I've started to play with Loki. My main experience is about
running large <a href=https://lucene.apache.org/solr/>Solr</a> and/or
<a href=https://www.elastic.co/de/elasticsearch>Elasticsearch</a> clusters, but I was looking for something
a bit easier and cheaper to host by myself. After all, I was not interested in all
the features from the ELK stack.</p><p>At the moment my data consist of a few labels and no actual logline, which is ok. I'm
more interested only in the labels. Some of those labels (in my case) contained the latitude (<code>lat</code>),
longitude (<code>long</code>) and geohash (<code>geohash</code>) of a given location. I also included some descriptive
information like <code>place</code> and <code>country</code>.</p><p>I wanted to plot this into a map using the <a href=https://grafana.com/grafana/plugins/grafana-worldmap-panel/installation>Worldmap
Panel</a>. Yet, it was a bit
tricky. I had already run a container with the latest version of Grafana since I was using
the Explore UI from Grafana with the Loki datasource to check the incoming data. I ran the
following command to add the world map panel:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>$ docker run -d -p 3000:3000 -e <span class=s2>&#34;GF_INSTALL_PLUGINS=grafana-worldmap-panel&#34;</span> grafana/grafana
</code></pre></div><p>My initial thought was to point the Worldmap Panel to the Loki datasource and run one of the
<a href=https://github.com/grafana/loki/blob/master/docs/logql.md>LogQL</a> queries against it. The query
ended up looking like:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=nx>sum</span><span class=p>(</span><span class=nx>count_over_time</span><span class=p>(</span><span class=p>{</span><span class=nx>geohash</span><span class=o>=</span><span class=o>~</span><span class=s2>&#34;.+&#34;</span><span class=p>}</span><span class=p>[</span><span class=mi>1</span><span class=nx>h</span><span class=p>]</span><span class=p>)</span><span class=p>)</span> <span class=nx>by</span> <span class=p>(</span><span class=nx>geohash</span><span class=p>,</span><span class=nx>lat</span><span class=p>,</span><span class=kr>long</span><span class=p>,</span><span class=nx>country</span><span class=p>,</span><span class=nx>place</span><span class=p>)</span>
</code></pre></div><p>My initial thought was to point the Worldmap Panel to the Loki datasource and run one of the
<a href=https://github.com/grafana/loki/blob/master/docs/logql.md>LogQL</a> queries against it. The query
ended up looking like:</p><p>This didn't work. Using the query inspector from Grafana I noticed that the response payload
from Loki was almost identical to the output of a Prometheus query. The next step was
to try and replicate the setup shown in <a href=https://www.robustperception.io/using-geohashes-with-the-worldmap-panel-and-prometheus>this
post</a>.</p><p>Trying to show the data setting the Location Data as a geohash yielded this error:</p><pre><code>Error: Missing geohash value
</code></pre><p>Which made a bit of sense, since we need to set the <code>{{ geohash }}</code> as the legend of our query. This
makes the <code>geohash</code> label (when using a Prometheus datasource) available to the Worldmap panel. Since
the legend input is missing from the Loki datasource it is not possible to do set it up this way.
Since I already have the <code>lat</code> and <code>long</code> available from the query, I also tried to use the
Location Data as a table, the setup ended up looking like:</p><picture>
<source type=image/webp srcset=/images/loki-worldmap-panel/loki-table-fail.webp><source type=image/png srcset=/images/loki-worldmap-panel/loki-table-fail.png><img src=/images/loki-worldmap-panel/loki-table-fail.png class=align-center alt="Setup of the Loki datasource as a table" loading=lazy style=max-width:50%></picture><p>Although this setup didn't produce any error it didn't visualize anything on the map either 🤷‍♂️.
The missing <strong>piece of the puzzle</strong> is that we can configure the Loki datasource as a Prometheus
datasource in Grafana 🤯.</p><p>To do this we need to create a Prometheus datasource in Grafana but point it out to the Loki
endpoint:</p><picture>
<source type=image/webp srcset=/images/loki-worldmap-panel/loki-and-prometheus-datasources.webp><source type=image/png srcset=/images/loki-worldmap-panel/loki-and-prometheus-datasources.png><img src=/images/loki-worldmap-panel/loki-and-prometheus-datasources.png class=align-center alt="Both datasources configured in the Grafana instance" loading=lazy style=max-width:100%></picture><p>As you can see we use the same URL, but we need to add the <code>/loki</code> path to the Prometheus datasource.</p><p>Using Loki as a Prometheus datasources allows us to use the same query as before, but have
access to the configuration options only available for a Prometheus datasource. We can now follow the
instructions in the <a href=https://www.robustperception.io/using-geohashes-with-the-worldmap-panel-and-prometheus>mentioned
post</a> to
visualize the labels stored in a Loki datasource in the Worldmap panel.</p><h2 id=summary>Summary</h2><p>TL;DR you can configure a Loki datasource as a Prometheus datasource
in Grafana, which will provide the same bells and whistles of a normal Prometheus server. Keep in mind that
LogQL, the query language implemented by Loki, is a subset of PromQL, which means that not all
functions, aggregations or operators will be available.</p><p>This step of configuring Loki as a Prometheus datasource is mandatory (until the publishing date of
this post) to get the Worldmap Panel plugin playing nicely with your Loki datasource. I imagine that
in the no so far future Grafana's Loki support will be easier to use and it will change its behavior
depending on how you want to use the data, which will make things (like using a 3rd party plugin)
easier.</p></section></article><footer id=post-meta class=clearfix><svg class="avatar" width="50" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#cbd5e0" d="M20.3 12.04l1.01 3a1 1 0 01-1.26 1.27l-3.01-1a7 7 0 113.27-3.27zM11 10a1 1 0 100-2 1 1 0 000 2zm3 0a1 1 0 100-2 1 1 0 000 2zm3 0a1 1 0 100-2 1 1 0 000 2z"/><path fill="#4a5568" d="M15.88 17.8a7 7 0 01-8.92 2.5l-3 1.01a1 1 0 01-1.27-1.26l1-3.01A6.97 6.97.0 015 9.1a9 9 0 0010.88 8.7z"/></svg><a href=https://twitter.com/jorgelbg><div><span class=dark>Want to leave a comment?</span>
<span>Drop me a message on Twitter @jorgelbg</span></div></a><section id=sharing><a class=twitter target=_blank href="https://twitter.com/intent/tweet?text=%2f%2fjorgelbg.me%2f2020%2f03%2fdisplaying-geohash-tags-from-a-loki-datasource-in-a-grafana-worldmap-panel%2f - Displaying%20geohash%20tags%20from%20a%20Loki%20datasource%20in%20a%20Grafana%20Worldmap%20Panel by @jorgelbg"><span class=icon-twitter>tweet</span></a></section></footer><ul id=post-list class="archive readmore"><h3>Read more</h3><li><a href=//jorgelbg.me/2020/02/web-ui-for-testing-dissect-patterns/><span>Web UI for testing dissect patterns</span><aside class=dates>Feb 21 2020</aside></a></li><li><a href=//jorgelbg.me/2020/01/better-url-search-with-elasticsearch/><span>Better URL search with Elasticsearch</span><aside class=dates>Jan 1 2020</aside></a></li><li><a href=//jorgelbg.me/2019/05/how-to-rename-index-patterns-in-kibana/><span>How to rename index patterns in Kibana</span><aside class=dates>May 21 2019</aside></a></li></ul><footer id=footer><p class=small>© Copyright 2020 Jorge Luis Betancourt</p><p class="small cc">Icons made by
<a href=https://www.freepik.com/ title=Freepik>Freepik</a> from
<a href=https://www.flaticon.com/ title=Flaticon>www.flaticon.com</a> is
licensed by
<a href=https://creativecommons.org/licenses/by/3.0/ title="Creative Commons BY 3.0" target=_blank>CC 3.0 BY</a></p></footer></section><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-115201846-1','auto');ga('send','pageview');}</script></body></html>