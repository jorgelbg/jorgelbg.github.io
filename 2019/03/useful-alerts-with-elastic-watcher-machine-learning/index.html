<!doctype html><html lang=en-us><head><link rel=preload href=//jorgelbg.me/css/style.css as=style><link rel=stylesheet href=//jorgelbg.me/css/style.css media=print onload="this.media='all'"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Jorge Luis Betancourt"><meta name=description content="Computo Ergo Sum"><meta name=generator content="Hugo 0.58.3"><title>Useful alerts with Elastic Watcher &amp; Machine Learning</title><link rel="shortcut icon" href=//jorgelbg.me/images/favicon.ico><link rel=dns-prefetch href=//www.google-analytics.com/><link href=//jorgelbg.me/index.xml rel=alternate type=application/rss+xml title="Jorge Luis Betancourt"><meta property=og:title content="Useful alerts with Elastic Watcher &amp; Machine Learning"><meta property=og:description content="Create more useful alerts using Elastic's Watcher and Machine Learning."><meta property=og:type content=article><meta property=og:url content=//jorgelbg.me/2019/03/useful-alerts-with-elastic-watcher-machine-learning/><meta property=article:published_time content=2019-03-15T13:00:00+01:00><meta property=article:modified_time content=2019-12-10T19:58:38+01:00><meta itemprop=name content="Useful alerts with Elastic Watcher &amp; Machine Learning"><meta itemprop=description content="Create more useful alerts using Elastic's Watcher and Machine Learning."><meta itemprop=datePublished content=2019-03-15T13:00:00&#43;01:00><meta itemprop=dateModified content=2019-12-10T19:58:38&#43;01:00><meta itemprop=wordCount content=1034><meta itemprop=keywords content="elasticsearch,watcher,machine learning,"><meta name=twitter:card content=summary><meta name=twitter:title content="Useful alerts with Elastic Watcher &amp; Machine Learning"><meta name=twitter:description content="Create more useful alerts using Elastic's Watcher and Machine Learning."><meta name=twitter:site content=@https://twitter.com/jorgelbg></head><body><section id=wrapper><nav class=main-nav><a href=//jorgelbg.me></a></nav><article class=post><header><h1><a href=/2019/03/useful-alerts-with-elastic-watcher-machine-learning/><svg width="30" xmlns="http://www.w3.org/2000/svg" version="1" viewBox="0 0 483 483"><path d="M255 209c-5 6-5 14 0 19 22 22 22 58 0 80L140 423a56 56 0 0 1-79 0l-18-17a56 56 0 0 1 0-80l115-115c6-5 6-14 1-19s-14-5-20 0L24 307a83 83 0 0 0 0 118l18 17a83 83 0 0 0 117 0l115-115c33-32 33-85 0-118-5-5-13-5-19 0z"/><path d="M459 58l-18-17a83 83 0 0 0-117 0L209 156a83 83 0 0 0 0 118c5 5 13 5 19 0s5-14 0-20a56 56 0 0 1 0-79L343 60c22-22 57-22 79 0l17 17c22 22 22 58 0 80L324 272c-5 5-5 13 0 19 3 2 7 4 10 4s7-1 9-4l115-115a83 83 0 0 0 1-118z"/></svg>Useful alerts with Elastic Watcher &amp; Machine Learning</a></h1><h2 class=headline><span>March 15, 2019</span>
<span class=tag><svg fill="#718096" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"><path class="heroicon-ui" d="M2.59 13.41A1.98 1.98.0 0 1 2 12V7a5 5 0 0 1 5-5h4.99c.53.0 1.04.2 1.42.59l8 8a2 2 0 0 1 0 2.82l-8 8a2 2 0 0 1-2.82.0l-8-8zM20 12l-8-8H7a3 3 0 0 0-3 3v5l8 8 8-8zM7 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg><a style=margin-left:10px href=//jorgelbg.me/tags/elasticsearch>elasticsearch</a></span>
<span class=tag><svg fill="#718096" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"><path class="heroicon-ui" d="M2.59 13.41A1.98 1.98.0 0 1 2 12V7a5 5 0 0 1 5-5h4.99c.53.0 1.04.2 1.42.59l8 8a2 2 0 0 1 0 2.82l-8 8a2 2 0 0 1-2.82.0l-8-8zM20 12l-8-8H7a3 3 0 0 0-3 3v5l8 8 8-8zM7 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg><a style=margin-left:10px href=//jorgelbg.me/tags/watcher>watcher</a></span>
<span class=tag><svg fill="#718096" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"><path class="heroicon-ui" d="M2.59 13.41A1.98 1.98.0 0 1 2 12V7a5 5 0 0 1 5-5h4.99c.53.0 1.04.2 1.42.59l8 8a2 2 0 0 1 0 2.82l-8 8a2 2 0 0 1-2.82.0l-8-8zM20 12l-8-8H7a3 3 0 0 0-3 3v5l8 8 8-8zM7 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg><a style=margin-left:10px href=//jorgelbg.me/tags/machine-learning>machine learning</a></span></h2><p class=last-edited><a href=https://github.com/jorgelbg/jorgelbg.github.io/commit/2a5046fa0fb8ae4b8bd51eff096793f2d4c629b9 title="Add last edited text to the articles">Last edited on 10 December 2019</a></p></header><section id=post-body><p>Alerts should be meaningful, simply getting a notification about something
happening is not enough. A <a href=https://blog.danslimmon.com/2017/10/02/what-makes-a-good-alert/>good alert</a>
should be <strong>actionable</strong> and <strong>investigable</strong>. For me, this means getting a
answer to the following questions:</p><h3 id=what-happened>What happened?</h3><p>Was the traffic to the Web site unusually low? Did the number of errors
increase? This is the type of information that the alert should contain in a
clear and visible way.</p><h3 id=why-an-alert-triggered>Why an alert triggered?</h3><p>What does it mean if the traffic is <em>unusually low</em>, would a 5% qualify for
this category? What about 10%? How much are too many errors? What <em>type</em> of
errors has increased?</p><h3 id=what-s-next>What&rsquo;s next?</h3><p>Now that I&rsquo;ve received this alert, what to do next? What should I check first?
How do I get a first glance at the situation?</p><p>These questions are even more important if you add Machine Learning&trade; into
the mix. ML is not the holy grail of alerting. Yet, it can help detect
situations that you didn&rsquo;t foresee before. This means that sometimes you would
get a notification about an <em>anomaly</em> that will be the first time that happens.
If an alert answers the three previous questions it will steer you in the right
direction.</p><h2 id=putting-something-together>Putting something together</h2><p>Elastic stack now supports (with the addition of X-pack)
<a href=https://www.elastic.co/products/stack/alerting>alerting</a>. Even more
powerful (if you can afford it) combined with the use of <a href=https://www.elastic.co/products/stack/machine-learning>Machine
Learning</a>. And yes,
sounds pretty cool, and it is well integrated into
<a href=https://www.elastic.co/de/products/kibana>Kibana</a>.</p><p>Eventually, you will have more than one ML job configured, and it is likely that
this number will increase. Having 1 alerting job for each individual ML job
will not scale. Watcher UI it is simple enough if you want a simple threshold-based alert. But if you really want to use what Watcher offers you will end up
writing a ton of JSON to have a flexible enough alert.</p><p>If you google enough you will find a few <a href=https://www.elastic.co/blog/alerting-on-machine-learning-jobs-in-elasticsearch-v55>blog posts</a>
and even some <a href=https://github.com/elastic/examples/blob/master/Alerting/Sample%20Watches/ml_examples/bucket_watch.json>example jobs</a>
that will help you. But the example alerts that you usually find for Watcher
are very simple. No one can write a perfect example tailored to your particular needs.</p><p>In a more practical way an alert should include, to answer the previous three questions:</p><ul><li>The name of the job that triggered the anomaly.</li></ul><p>This name should be clear and related to the data/situations that it is checking.</p><ul><li>Which specific feature(s) influenced this result.</li></ul><p>If you have a multi-metric job you will want to know which specific metric(s) triggered the anomaly.</p><ul><li>A link to the Anomaly Explorer clearing showing the issue.</li></ul><p>Probably you have a lot of dashboards in your ES cluster. Perhaps you&rsquo;re even
using <a href=https://grafana.com/>Grafana</a> with ES. Providing a link to all
dashboards in your organization that are related to the main issue is out of
the question. A link to the Anomaly explorer clearly highlighting the issue
should be a good start.</p><p>A reasonable useful alert message may look like:</p><pre><code>Job &lt;job name&gt;.
Anomaly of score=&lt;score&gt; at &lt;timestamp&gt; influenced by:
&lt;metric&gt; score=&lt;metric score&gt;, actual=&lt;value&gt;, (typical=&lt;value&gt;)
&lt;metric1&gt; score=&lt;metric1 score&gt;, actual=&lt;value&gt;, (typical=&lt;value&gt;)

&lt;deep dive link&gt;
</code></pre><p><a href=https://github.com/elastic/examples/blob/master/Alerting/Sample%20Watches/ml_examples/bucket_watch.json>This alert example</a>
it&rsquo;s a good starting point.</p><p>First of all, we don&rsquo;t want to maintain one alert per ML job because
it would lead to a lot of duplication.</p><p>Let&rsquo;s remove the <code>term</code> query that it&rsquo;s matching in the <code>job_id</code>:</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=s2>&#34;term&#34;</span><span class=err>:</span> <span class=p>{</span>
 <span class=nt>&#34;job_id&#34;</span><span class=p>:</span> <span class=s2>&#34;farequote_response&#34;</span>
<span class=p>}</span></code></pre></div><p>Now our alert will &ldquo;watch&rdquo; all jobs in the cluster. You can also tweak the rest
of the options: <code>interval</code>, the <code>range</code> filter, etc.</p><p>The core issue of the alert is what its included in the <code>text</code> key inside the
specific <code>actions</code> elements:</p><pre><code>&quot;actions&quot;: {
  &quot;log&quot;: {
    &quot;logging&quot;: {
      &quot;text&quot;: &quot;Anomalies:\n{{#ctx.payload.hits.hits}}
        score={{_source.anomaly_score}}
        at time={{_source.timestamp}}\n{{/ctx.payload.hits.hits}}&quot;
    }
  }
}
</code></pre><p>In a real-life scenario this would be probably the message posted to a
specific Slack (or similar) channel. We need to collect some information
before sending the alert.</p><p>Thankfully ES Watcher supports <a href=https://www.elastic.co/guide/en/x-pack/current/transform-script.html>transform scripts</a>
written in <a href=https://www.elastic.co/guide/en/elasticsearch/reference/master/modules-scripting-painless.html>painless</a>.
Which will allow us to do a lot of transformations to the data before the
alert is sent.</p><h4 id=get-the-name-of-the-job-that-triggered-the-anomaly>Get the name of the job that triggered the anomaly.</h4><p>We can take the job name or <code>job_id</code> from the first element that matches our query scheduled query:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=k>return</span> <span class=p>[</span>
 <span class=s1>&#39;job_id&#39;</span><span class=o>:</span> <span class=nx>ctx</span><span class=p>.</span><span class=nx>payload</span><span class=p>.</span><span class=nx>first</span><span class=p>.</span><span class=nx>hits</span><span class=p>.</span><span class=nx>hits</span><span class=mf>.0</span><span class=p>.</span><span class=nx>_source</span><span class=p>.</span><span class=nx>job_id</span>
<span class=p>]</span>
</code></pre></div><h4 id=round-the-scores-not-a-lot-of-useful-information-after-2-decimal-places>Round the scores (not a lot of useful information after 2 decimal places)</h4><p>For rounding the scores we can use the <a href=https://www.elastic.co/guide/en/elasticsearch/painless/6.1/painless-api-reference.html>DecimalFormat</a>
class:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=nx>def</span> <span class=nx>df</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>DecimalFormat</span><span class=p>(</span><span class=s1>&#39;##.##&#39;</span><span class=p>);</span>

<span class=k>return</span> <span class=p>[</span>
 <span class=s1>&#39;anomaly_score&#39;</span><span class=o>:</span> <span class=nx>df</span><span class=p>.</span><span class=nx>format</span><span class=p>(</span><span class=nx>ctx</span><span class=p>.</span><span class=nx>payload</span><span class=p>.</span><span class=nx>anomaly_score</span><span class=p>)</span>
<span class=p>]</span>
</code></pre></div><h4 id=get-the-start-time-end-time-of-the-anomaly>Get the start time &amp; end time of the anomaly</h4><p>This is a bit tricky, we know when the anomaly was triggered, but we still need
to provide a timeframe to Kibana in order to show the anomaly when it happened.
For this we can take the moment when the anomaly was triggered and
substract/add some minutes to get a timeframe when the anomaly should be
clearly visible:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=k>def</span> <span class=nf>current</span> <span class=o>=</span> <span class=n>Instant</span>
  <span class=o>.</span><span class=n>ofEpochMilli</span><span class=p>(</span><span class=n>ctx</span><span class=o>.</span><span class=n>payload</span><span class=o>.</span><span class=n>first</span><span class=o>.</span><span class=n>hits</span><span class=o>.</span><span class=n>hits</span><span class=o>.</span><span class=mf>0.</span><span class=n>_source</span><span class=o>.</span><span class=n>timestamp</span><span class=p>)</span>
  <span class=o>.</span><span class=n>atZone</span><span class=p>(</span><span class=n>ZoneId</span><span class=o>.</span><span class=n>systemDefault</span><span class=p>());</span>

<span class=k>return</span> <span class=p>[</span>
 <span class=s1>&#39;start_time&#39;</span> <span class=p>:</span> <span class=n>current</span><span class=o>.</span><span class=n>minus</span><span class=p>(</span><span class=n>Duration</span><span class=o>.</span><span class=n>ofMinutes</span><span class=p>(</span><span class=mi>20</span><span class=p>))</span>
    <span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>DateTimeFormatter</span><span class=o>.</span><span class=n>ISO_INSTANT</span><span class=p>),</span>
 <span class=s1>&#39;end_time&#39;</span> <span class=p>:</span> <span class=n>current</span><span class=o>.</span><span class=n>plus</span><span class=p>(</span><span class=n>Duration</span><span class=o>.</span><span class=n>ofMinutes</span><span class=p>(</span><span class=mi>20</span><span class=p>))</span>
    <span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>DateTimeFormatter</span><span class=o>.</span><span class=n>ISO_INSTANT</span><span class=p>)</span>
<span class=p>]</span></code></pre></div><p>For this example, we&rsquo;re assuming a [-20 minutes, +20 minutes] window around the
anomaly timestamp.</p><h4 id=get-the-list-of-metrics-that-triggered-the-anomaly>Get the list of metrics that triggered the anomaly.</h4><p>Finally, we need a list of all metrics (influencers) that triggered the anomaly.
A bit more of scripting:</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=k>return</span> <span class=p>[</span>
 <span class=s1>&#39;anomaly_details&#39;</span><span class=o>:</span> <span class=nx>ctx</span><span class=p>.</span><span class=nx>payload</span><span class=p>.</span><span class=nx>second</span><span class=p>.</span><span class=nx>hits</span><span class=p>.</span><span class=nx>hits</span><span class=p>.</span><span class=nx>stream</span><span class=p>().</span><span class=nx>map</span><span class=p>(</span> <span class=nx>p</span> <span class=o>-&gt;</span> <span class=p>[</span>
    <span class=s1>&#39;metric&#39;</span><span class=o>:</span> <span class=nx>p</span><span class=p>.</span><span class=nx>_source</span><span class=p>.</span><span class=nx>partition_field_value</span><span class=p>,</span>
    <span class=s1>&#39;score&#39;</span><span class=o>:</span> <span class=nx>df</span><span class=p>.</span><span class=nx>format</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>_source</span><span class=p>.</span><span class=nx>record_score</span><span class=p>),</span>
    <span class=s1>&#39;actual&#39;</span><span class=o>:</span> <span class=nx>df</span><span class=p>.</span><span class=nx>format</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>_source</span><span class=p>.</span><span class=nx>actual</span><span class=mf>.0</span><span class=p>),</span>
    <span class=s1>&#39;typical&#39;</span><span class=o>:</span><span class=nx>df</span><span class=p>.</span><span class=nx>format</span><span class=p>(</span><span class=nx>p</span><span class=p>.</span><span class=nx>_source</span><span class=p>.</span><span class=nx>typical</span><span class=mf>.0</span><span class=p>)</span>
  <span class=p>]).</span><span class=nx>collect</span><span class=p>(</span><span class=nx>Collectors</span><span class=p>.</span><span class=nx>toList</span><span class=p>())</span>
<span class=p>]</span>
</code></pre></div><h3 id=gluing-everything>Gluing everything</h3><p>Now that our transform script provides a more friendly view of the data we can
configure the actual message that is going to be posted to your
email/chat/ system.</p><p>When visualizing an anomaly in the Anomaly explorer in Kibana you may notice
that it has a URL similar to this one.</p><pre><code>http://kibana/app/ml#/explorer?_g=(ml:(jobIds:!(&lt;JOB_NAME&gt;)),refreshInterval:(pause:!f,value:30000),time:(from:'&lt;START_TIME&gt;',mode:quick,to:'&lt;END_TIME&gt;'))&amp;_a=(filters:!(),mlCheckboxShowCharts:(showCharts:!t),mlExplorerSwimlane:(viewBy:domain.keyword),mlSelectInterval:(interval:(display:Auto,val:auto)),mlSelectLimit:(limit:(display:'10',val:10)),mlSelectSeverity:(threshold:(display:major,val:50)))
</code></pre><p>Now we can interpolate the data extracted from the anomaly into this link and
go from Slack to Kibana showing exactly what we need to see.</p><p>Finally the <code>text</code> section of our alert would look similar to:</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=s2>&#34;text&#34;</span><span class=err>:</span> <span class=s2>&#34;
</span><span class=s2>  *Job*: {{ctx.payload.job_id}}\n
</span><span class=s2>  Anomaly of score={{ctx.payload.anomaly_score}} at
</span><span class=s2>  {{ctx.payload.bucket_time}} influenced by:\n
</span><span class=s2>  {{#ctx.payload.anomaly_details}}influencer={{metric}}:
</span><span class=s2>  score={{score}}, actual={{actual}} (typical={{typical}})\n
</span><span class=s2>  {{/ctx.payload.anomaly_details}}\n\n
</span><span class=s2>
</span><span class=s2>  :kibana: &lt;KIBANA_URL&gt;&#34;</span>
<span class=err>}</span></code></pre></div><blockquote><p>Note: I&rsquo;ve removed the <code>KIBANA_URL</code> because it was discussed before and was making the entire example harder to read.</p></blockquote><h2 id=tl-dr>TL;DR</h2><p>After gluing everything together we get a notification that looks like:</p><p><img src=/images/es-watcher-ml-alert/final-alert-example.png alt="Final example alert in Slack" title="Example of an alert with all information in Slack"></p><p>You can get the full code for the example discussed in this blog post <a href=https://gist.github.com/jorgelbg/b1111add2436ca946b1b049fb63aaddb>in this gist</a>.</p></section></article><footer id=post-meta class=clearfix><svg class="avatar" width="50" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="#cbd5e0" d="M20.3 12.04l1.01 3a1 1 0 0 1-1.26 1.27l-3.01-1a7 7 0 1 1 3.27-3.27zM11 10a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm3 0a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/><path fill="#4a5568" d="M15.88 17.8a7 7 0 0 1-8.92 2.5l-3 1.01a1 1 0 0 1-1.27-1.26l1-3.01A6.97 6.97.0 0 1 5 9.1a9 9 0 0 0 10.88 8.7z"/></svg><a href=https://twitter.com/jorgelbg><div><span class=dark>Want to leave a comment?</span>
<span>Drop me a message on Twitter @jorgelbg</span></div></a><section id=sharing><a class=twitter target=_blank href="https://twitter.com/intent/tweet?text=%2f%2fjorgelbg.me%2f2019%2f03%2fuseful-alerts-with-elastic-watcher-machine-learning%2f - Useful%20alerts%20with%20Elastic%20Watcher%20%26%20Machine%20Learning by @jorgelbg"><span class=icon-twitter>tweet</span></a></section></footer><ul id=post-list class="archive readmore"><h3>Read more</h3><li><a href=/2019/05/how-to-rename-index-patterns-in-kibana/><span>How to rename index patterns in Kibana</span><aside class=dates>May 21 2019</aside></a></li><li><a href=/2019/02/display-the-applications-version-in-your-grafana-dashboards/><span>Display the application&#39;s version in your Grafana dashboards</span><aside class=dates>Feb 17 2019</aside></a></li><li><a href=/2018/12/optimize-grafana-dashboards-with-elasticsearch-index-aliases/><span>Optimize Grafana dashboards with Elasticsearch index aliases</span><aside class=dates>Dec 20 2018</aside></a></li></ul><footer id=footer><p class=small>Â© Copyright 2019 Jorge Luis Betancourt</p><p class="small cc">Icons made by
<a href=https://www.freepik.com/ title=Freepik>Freepik</a> from
<a href=https://www.flaticon.com/ title=Flaticon>www.flaticon.com</a> is
licensed by
<a href=https://creativecommons.org/licenses/by/3.0/ title="Creative Commons BY 3.0" target=_blank>CC 3.0 BY</a></p></footer></section><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-115201846-1','auto');ga('send','pageview');}</script></body></html>